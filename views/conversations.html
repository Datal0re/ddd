<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: http://localhost:3001; font-src 'self' data:; connect-src 'self' http://localhost:3001; media-src 'self' blob: data: http://localhost:3001; object-src 'none'; frame-src 'none'; child-src 'none'; worker-src 'none'; form-action 'self';"
    />
    <title>Data Dumpster Diver ‚Äì Conversations</title>
    <link rel="stylesheet" href="../public/styles.css" />
    <link rel="stylesheet" href="../enhanced-design.css" />
    <script src="../public/navigation.js"></script>
    <script src="../public/pagination.js"></script>
    <script src="../public/loading-system.js"></script>
    <style>
      /* Unique styles for conversations.html - everything else is in public/styles.css */
      .search-container {
        margin-bottom: 2rem;
      }

      .conversation-item a {
        display: block;
        padding: 1.5rem;
        text-decoration: none;
        color: var(--text-primary);
      }

      .conversation-date {
        color: var(--text-muted);
        font-size: 0.875rem;
      }
    </style>
  </head>

  <body>
    <!-- Particle Background -->
    <div class="particle-background" id="particleBackground"></div>

    <div class="container">
      <div class="page-header page-header-with-nav">
        <div
          style="margin-bottom: 1rem; display: flex; gap: 0.5rem; align-items: center"
        >
          <!-- <button
            onclick="deleteCurrentSession()"
            class="btn btn-danger"
            style="font-size: 0.9rem"
            title="Delete this session and all its data"
          >
            üóëÔ∏è Delete Session
          </button> -->
        </div>
        <h1>Your Conversations</h1>
        <p style="color: var(--text-secondary)">
          Browse through your ChatGPT conversation history
        </p>
      </div>

      <div class="search-container">
        <input
          type="search"
          id="search"
          class="search-input"
          placeholder="üîç Search conversation titles..."
          onkeyup="filter()"
          autocomplete="off"
        />
        <div
          id="search-results"
          style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-muted)"
        >
          <span id="result-count">Loading...</span> conversations found
        </div>
      </div>

      <div id="conversation-list" class="conversation-list-optimized">
        <!-- Conversations will be loaded here -->
      </div>

      <div id="pagination-controls">
        <!-- Pagination controls will be rendered here -->
      </div>

      <div id="empty-state" class="card empty-state" style="display: none">
        <div style="font-size: 3rem; margin-bottom: 1rem">üì≠</div>
        <h3>No conversations found</h3>
        <p style="color: var(--text-secondary)">
          No conversations were found in this session. Try uploading a different ChatGPT
          export file.
        </p>
        <a href="upload.html" style="margin-top: 1rem; display: inline-block">
          <button class="secondary">‚Üê Back to Upload</button>
        </a>
      </div>

      <div style="margin-top: 3rem; text-align: center">
        <a href="upload.html" style="color: var(--text-muted); font-size: 0.875rem">
          ‚Üê Back to Upload
        </a>
      </div>
    </div>

    <script>
      let conversations = [];
      let sessionId = '';

      // Load conversations on page load
      document.addEventListener('DOMContentLoaded', async function () {
        // Check if electronAPI is available
        if (!window.electronAPI) {
          console.error('electronAPI is not available!');
          showError(
            "Electron API is not available. Make sure you're running this in the Electron app."
          );
          return;
        }

        console.log('electronAPI available:', Object.keys(window.electronAPI));

        const urlParams = new URLSearchParams(window.location.search);
        sessionId = urlParams.get('session');

        // If no session ID provided, try to get first available session
        if (!sessionId) {
          try {
            const sessionsResult = await window.electronAPI.getAllSessions();
            if (sessionsResult.success && sessionsResult.sessions.length > 0) {
              sessionId = sessionsResult.sessions[0].id;
              // Update URL to include session ID
              window.history.replaceState(
                {},
                '',
                `conversations.html?session=${sessionId}`
              );
            } else {
              showError('No sessions available. Please upload data first.');
              return;
            }
          } catch (err) {
            console.error('Failed to load sessions:', err);
            showError(`Failed to load sessions: ${err.message || 'Unknown error'}`);
            return;
          }
        }

        // Initialize pagination system
        paginationSystem = new PaginationSystem({
          pageSize: 20,
          sortBy: 'date',
          sortOrder: 'desc',
          onPageChange: (page, items) => {
            renderConversations(items);
            updateResultCount();
          },
        });

        // Make pagination system globally accessible
        window.paginationSystem = paginationSystem;

        // Show loading skeletons
        paginationSystem.renderSkeletons('conversation-list');

        try {
          const result = await window.electronAPI.getConversations(sessionId);
          if (result.success) {
            conversations = result.conversations;
            paginationSystem.setItems(conversations);
            paginationSystem.renderControls('pagination-controls');
            // Clear skeletons and render actual conversations
            renderConversations();
            updateResultCount();
          } else {
            showError(result.error || 'Failed to load conversations');
          }
        } catch (err) {
          console.error('Error loading conversations:', err);
          showError(`Error loading conversations: ${err.message || 'Unknown error'}`);
        }
      });

      function renderConversations(itemsToRender = null) {
        const listContainer = document.getElementById('conversation-list');
        const emptyState = document.getElementById('empty-state');

        // Use provided items or get current page items
        const items =
          itemsToRender ||
          (paginationSystem ? paginationSystem.getCurrentPageItems() : []);

        // Clear existing content
        listContainer.innerHTML = '';

        if (items.length === 0) {
          emptyState.style.display = 'block';
          return;
        }

        emptyState.style.display = 'none';

        items.forEach((conv, index) => {
          const item = document.createElement('div');
          item.className = 'conversation-item conversation-item-optimized fade-in';
          item.style.animationDelay = `${index * 50}ms`;

          item.innerHTML = `
            <a href="conversation.html?id=${conv.id}&session=${sessionId}">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 500; margin-bottom: 0.25rem; word-break: break-word;">
                    ${conv.title || 'Untitled Conversation'}
                  </div>
                  <div class="conversation-date">
                    ${conv.date}
                  </div>
                </div>
                <div style="color: var(--primary-blue); font-size: 1.25rem; flex-shrink: 0;">
                  ‚Üí
                </div>
              </div>
            </a>
          `;
          listContainer.appendChild(item);
        });
      }

      function updateResultCount() {
        const resultCount = document.getElementById('result-count');
        if (paginationSystem && resultCount) {
          const info = paginationSystem.getInfo();
          resultCount.textContent = `${info.totalItems}`;
        }
      }

      // Get search input element and add event listener
      const searchInput = document.getElementById('search');
      searchInput.addEventListener('keyup', function (event) {
        const searchTerm = event.target.value;
        if (paginationSystem) {
          paginationSystem.setSearchTerm(searchTerm);
          paginationSystem.renderControls('pagination-controls');
        }
      });

      function filter() {
        if (paginationSystem) {
          const searchTerm = searchInput.value;
          paginationSystem.setSearchTerm(searchTerm);
          paginationSystem.renderControls('pagination-controls');
        }
      }

      // Delete current session function
      async function deleteCurrentSession() {
        if (!sessionId) {
          alert('No session to delete');
          return;
        }

        if (
          !confirm(
            'Are you sure you want to delete this session? This action cannot be undone and will permanently remove all conversation data and media files. You will be redirected to the home page.'
          )
        ) {
          return;
        }

        try {
          const result = await window.electronAPI.deleteSession(sessionId);
          if (result.success) {
            // Redirect to home page after successful deletion
            window.location.href = 'index.html';
          } else {
            alert(`Failed to delete session: ${result.error || 'Unknown error'}`);
          }
        } catch (error) {
          console.error('Error deleting session:', error);
          alert(`Error deleting session: ${error.message || 'Unknown error'}`);
        }
      }

      function showError(message) {
        const listContainer = document.getElementById('conversation-list');
        listContainer.innerHTML = `
        <div class="card" style="background: var(--error-bg); color: var(--error-text);">
          ${message}
        </div>
      `;
      }

      // Create floating particles for enhanced visual effect
      function createParticles() {
        const container = document.getElementById('particleBackground');
        if (!container) return;

        const particleCount = 25;

        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement('div');
          particle.className = 'particle';
          particle.style.left = Math.random() * 100 + '%';
          particle.style.animationDelay = Math.random() * 20 + 's';
          particle.style.animationDuration = 15 + Math.random() * 10 + 's';
          container.appendChild(particle);
        }
      }

      // Add keyboard navigation
      document.addEventListener('keydown', function (e) {
        if (
          e.key === '/' &&
          document.activeElement !== document.getElementById('search')
        ) {
          e.preventDefault();
          document.getElementById('search').focus();
        }

        if (e.key === 'Escape') {
          document.getElementById('search').blur();
          document.getElementById('search').value = '';
          filter();
        }
      });

      // Initialize particles when DOM is loaded
      document.addEventListener('DOMContentLoaded', createParticles);
    </script>
  </body>
</html>
