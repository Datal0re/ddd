name: Alpha Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      create_git_tag:
        description: 'Create git tag'
        required: false
        default: true
        type: boolean
      skip_tests:
        description: 'Skip pre-release checks'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  # Alpha Release Process
  alpha-release:
    name: Alpha Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.release.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run pre-release checks
        if: github.event.inputs.skip_tests != 'true'
        run: |
          npm run lint-and-fix
          echo "Pre-release checks completed"

      - name: Create alpha release
        id: release
        run: |
          VERSION_BUMP="${{ github.event.inputs.version_bump || 'patch' }}"
          CREATE_TAG="${{ github.event.inputs.create_git_tag || 'true' }}"
          SKIP_TESTS="${{ github.event.inputs.skip_tests || 'false' }}"

          # Backup current state for rollback
          cp package.json package.json.backup

          # Build command with flags
          CMD="node scripts/create-alpha-release.js"
          if [[ "$SKIP_TESTS" == "true" ]]; then
            CMD="$CMD --skip-tests"
          fi
          if [[ "$CREATE_TAG" == "true" ]]; then
            CMD="$CMD --commit --tag"
          fi
          CMD="$CMD --platform all"

          echo "Running: $CMD"

          # Run with error handling
          if ! $CMD; then
            echo "‚ùå Alpha release failed, rolling back..."
            cp package.json.backup package.json
            echo "Rollback completed"
            exit 1
          fi

          # Extract version from package.json
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Created alpha release version: $VERSION"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: alpha-release-${{ steps.release.outputs.version }}
          path: dist/
          retention-days: 30

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.release.outputs.version }}
          name: Data Dumpster Diver v${{ steps.release.outputs.version }} (Alpha)
          body: |
            ## üöÄ Alpha Release v${{ steps.release.outputs.version }}

            This is an alpha release of Data Dumpster Diver for testing purposes.

            ### üì¶ Installation

            Choose the appropriate download for your platform:
            - **macOS**: Download the .dmg file (Intel or Apple Silicon)
            - **Windows**: Download the .exe installer
            - **Linux**: Download the .AppImage file

            ### ‚ö†Ô∏è Alpha Notice

            This is an alpha release and may contain bugs or incomplete features. Please report any issues you encounter.

            ### üìã What's New

            See the [CHANGELOG](docs/CHANGELOG.md) for detailed changes in this version.

            ---
          files: dist/*
          draft: false
          prerelease: true
          generate_release_notes: false
        env:
          GH_PAT: ${{ secrets.GH_PAT }}

      - name: Push changes (if tags were created)
        if: github.event.inputs.create_git_tag == 'true'
        run: |
          git push origin --follow-tags
