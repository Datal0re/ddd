name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  NODE_VERSION: '20'

jobs:
  # Code Quality Checks
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Check Prettier formatting
        run: npm run format:check

      - name: Type check (if applicable)
        run: |
          if [ -f "tsconfig.json" ]; then
            npm run typecheck
          else
            echo "No TypeScript configuration found, skipping type check"
          fi

  # Application Health Check
  health:
    name: Application Health
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start API server
        run: |
          npm run web &
          sleep 10
          curl -f http://localhost:3001/api/health || exit 1

      - name: Test application startup
        run: |
          timeout 30s npm start || true
          echo "Application startup test completed"

  # Build Test
  build-test:
    name: Build Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Test build process
        run: |
          npm run build
          echo "Build test completed successfully"

      - name: Verify build artifacts
        run: |
          if [ -d "dist" ]; then
            echo "Build artifacts created:"
            ls -la dist/
          else
            echo "No dist directory found"
            exit 1
          fi
        shell: bash

  # Security Scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate || true

      - name: Check for sensitive data
        run: |
          echo "Checking for potential sensitive data..."
          if grep -r "password\|secret\|token\|key" --include="*.js" --include="*.json" --exclude-dir=node_modules .; then
            echo "Warning: Potential sensitive data found. Please review."
          else
            echo "No obvious sensitive data found in source files."
          fi

  # Documentation Check
  docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ -f "README.md" ]; then
            echo "README.md exists"
          else
            echo "Warning: No README.md found"
          fi

      - name: Check CHANGELOG exists
        run: |
          if [ -f "docs/CHANGELOG.md" ]; then
            echo "CHANGELOG.md exists"
          else
            echo "Warning: No CHANGELOG.md found"
          fi

      - name: Check AGENTS.md exists
        run: |
          if [ -f "AGENTS.md" ]; then
            echo "AGENTS.md exists"
          else
            echo "Warning: No AGENTS.md found"
          fi

  # Performance Check (basic)
  performance:
    name: Performance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check bundle size
        run: |
          echo "Checking application bundle size..."
          npm run build

          if [ -d "dist" ]; then
            TOTAL_SIZE=$(du -sh dist | cut -f1)
            echo "Total build size: $TOTAL_SIZE"
            
            # Count files
            FILE_COUNT=$(find dist -type f | wc -l)
            echo "Total files: $FILE_COUNT"
            
            # Validate size (warn if > 200MB)
            SIZE_MB=$(du -sm dist | cut -f1)
            if [ "$SIZE_MB" -gt 200 ]; then
              echo "⚠️ Warning: Build size is large (${SIZE_MB}MB)"
            fi
            
            # Check for empty files
            EMPTY_FILES=$(find dist -type f -size 0 | wc -l)
            if [ "$EMPTY_FILES" -gt 0 ]; then
              echo "⚠️ Warning: Found $EMPTY_FILES empty files in build"
              find dist -type f -size 0
            fi
          else
            echo "❌ Error: No dist directory found after build"
            exit 1
          fi

  # Test Results Summary
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [quality, health, build-test, security, docs, performance]
    if: always()
    steps:
      - name: CI Summary
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Quality check
          if [ "${{ needs.quality.result }}" == "success" ]; then
            echo "✅ Code Quality: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Code Quality: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # Health check
          if [ "${{ needs.health.result }}" == "success" ]; then
            echo "✅ Application Health: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Application Health: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # Build test
          if [ "${{ needs.build-test.result }}" == "success" ]; then
            echo "✅ Build Test: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Build Test: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # Security scan
          if [ "${{ needs.security.result }}" == "success" ]; then
            echo "✅ Security Scan: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Security Scan: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # Documentation check
          if [ "${{ needs.docs.result }}" == "success" ]; then
            echo "✅ Documentation Check: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Documentation Check: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # Performance check
          if [ "${{ needs.performance.result }}" == "success" ]; then
            echo "✅ Performance Check: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Performance Check: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Overall Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
