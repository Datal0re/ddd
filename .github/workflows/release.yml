name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'stable'
        type: choice
        options:
          - stable
          - beta
          - alpha
      version_bump:
        description: 'Version bump type'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      create_git_tag:
        description: 'Create git tag'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: '20'
  CACHE_VERSION: 'v1'

jobs:
  # Code Quality Checks
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_alpha: ${{ steps.version.outputs.is_alpha }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Check formatting
        run: npm run format:check

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
            IS_ALPHA="false"
          else
            RELEASE_TYPE="${{ github.event.inputs.release_type || 'stable' }}"
            VERSION_BUMP="${{ github.event.inputs.version_bump || 'patch' }}"
            
            if [[ "$RELEASE_TYPE" == "alpha" ]]; then
              VERSION=$(node -p "
                const pkg = require('./package.json');
                const [major, minor, patch] = pkg.version.split('.').map(Number);
                \`${major}.${minor}.${patch + 1}-alpha\`;
              ")
              IS_ALPHA="true"
            elif [[ "$RELEASE_TYPE" == "beta" ]]; then
              VERSION=$(node -p "
                const pkg = require('./package.json');
                const [major, minor, patch] = pkg.version.split('.').map(Number);
                \`${major}.${minor}.${patch + 1}-beta\`;
              ")
              IS_ALPHA="false"
            else
              VERSION=$(node -p "
                const pkg = require('./package.json');
                const [major, minor, patch] = pkg.version.split('.').map(Number);
                \`${major}.${minor}.${patch + 1}\`;
              ")
              IS_ALPHA="false"
            fi
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_alpha=$IS_ALPHA" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Update package.json version
        if: github.event_name == 'workflow_dispatch'
        run: npm version ${{ env.VERSION }} --no-git-tag-version

      - name: Update changelog
        if: github.event_name == 'workflow_dispatch'
        run: |
          node scripts/update-changelog.js ${{ env.VERSION }} ${{ steps.version.outputs.is_alpha }}

      - name: Commit version changes
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_git_tag == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add package.json docs/CHANGELOG.md
          git commit -m "Release v${{ env.VERSION }}"
          git push origin main

      - name: Create git tag
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_git_tag == 'true'
        run: |
          git tag -a "v${{ env.VERSION }}" -m "Release v${{ env.VERSION }}"
          git push origin "v${{ env.VERSION }}"

  # Build Matrix for Multiple Platforms
  build:
    name: Build (${{ matrix.os }})
    needs: quality
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: mac
            arch: x64
            artifact_name: '*.dmg'
          - os: macos-latest
            platform: mac
            arch: arm64
            artifact_name: '*.dmg'
          - os: windows-latest
            platform: win
            arch: x64
            artifact_name: '*.exe'
          - os: ubuntu-latest
            platform: linux
            arch: x64
            artifact_name: '*.AppImage'
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          rm -rf node_modules package-lock.json
          npm install

      - name: Verify build tools
        run: |
          echo "Verifying build tools..."
          npm list electron-builder
          npm list dmg-builder || echo "dmg-builder not found (expected)"
          echo "Build tools verification completed"

      - name: Build for ${{ matrix.platform }} (${{ matrix.arch }})
        run: |
          if [[ "${{ matrix.platform }}" == "mac" ]]; then
            if [[ "${{ matrix.arch }}" == "arm64" ]]; then
              npm run build-mac -- --mac --arm64
            else
              npm run build-mac -- --mac --x64
            fi
          elif [[ "${{ matrix.platform }}" == "win" ]]; then
            npm run build-win
          else
            npm run build-linux
          fi
        shell: bash

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-${{ matrix.arch }}-${{ needs.quality.outputs.version }}
          path: dist/${{ matrix.artifact_name }}
          retention-days: 30

  # Create GitHub Release
  release:
    name: Create Release
    needs: [quality, build]
    runs-on: ubuntu-latest
    if: success()
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Verify build artifacts
        run: |
          echo "Verifying build artifacts before release..."
          mkdir -p release-assets

          # Check for artifacts from all platforms
          DMG_FILES=$(find artifacts -name "*.dmg" | wc -l)
          EXE_FILES=$(find artifacts -name "*.exe" | wc -l)
          APPIMAGE_FILES=$(find artifacts -name "*.AppImage" | wc -l)

          echo "Found artifacts:"
          echo "  - DMG files: $DMG_FILES"
          echo "  - EXE files: $EXE_FILES" 
          echo "  - AppImage files: $APPIMAGE_FILES"

          # Copy artifacts to release directory
          find artifacts -name "*.dmg" -o -name "*.exe" -o -name "*.AppImage" | while read file; do
            cp "$file" release-assets/
          done

          echo "Release assets prepared:"
          ls -la release-assets/

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.quality.outputs.version }}"
          IS_ALPHA="${{ needs.quality.outputs.is_alpha }}"

          if [[ "$IS_ALPHA" == "true" ]]; then
            cat << 'EOF' > release_notes.md
          ## üöÄ Alpha Release vVERSION_PLACEHOLDER

          This is an alpha release of Data Dumpster Diver for testing purposes.

          ### üì¶ Installation

          Choose the appropriate download for your platform:
          - **macOS**: Download the .dmg file (Intel or Apple Silicon)
          - **Windows**: Download the .exe installer
          - **Linux**: Download the .AppImage file

          ### ‚ö†Ô∏è Alpha Notice

          This is an alpha release and may contain bugs or incomplete features. Please report any issues you encounter.

          ### üìã What's New

          See the [CHANGELOG](docs/CHANGELOG.md) for detailed changes in this version.

          ---
          EOF
          else
            cat << 'EOF' > release_notes.md
          ## üéâ Release vVERSION_PLACEHOLDER

          This is a stable release of Data Dumpster Diver.

          ### üì¶ Installation

          Choose the appropriate download for your platform:
          - **macOS**: Download the .dmg file (Intel or Apple Silicon)
          - **Windows**: Download the .exe installer
          - **Linux**: Download the .AppImage file

          ### üìã What's New

          See the [CHANGELOG](docs/CHANGELOG.md) for detailed changes in this version.

          ### üôè Thank You

          Thank you for using Data Dumpster Diver!

          ---
          EOF
          fi

          # Substitute version
          sed -i.bak "s/VERSION_PLACEHOLDER/$VERSION/g" release_notes.md

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.quality.outputs.version }}
          name: Data Dumpster Diver v${{ needs.quality.outputs.version }}
          body: ${{ steps.release_notes.outputs.notes }}
          files: release-assets/*
          draft: false
          prerelease: ${{ needs.quality.outputs.is_alpha == 'true' }}
          generate_release_notes: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Status Check
        if: always()
        run: |
          echo "Release creation status: ${{ job.status }}"
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Release created successfully"
          else
            echo "‚ùå Release creation failed"
            echo "Checking for release artifacts..."
            ls -la release-assets/ || echo "No release assets found"
          fi

  # Update Alpha Release Summary (for alpha releases only)
  update-alpha-summary:
    name: Update Alpha Summary
    needs: [quality, build, release]
    runs-on: ubuntu-latest
    if: needs.quality.outputs.is_alpha == 'true'
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update alpha release summary
        run: |
          VERSION="${{ needs.quality.outputs.version }}"
          DATE=$(date +%Y-%m-%d)

          node scripts/update-alpha-summary.js $VERSION $DATE

      - name: Commit alpha summary
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/archive/ALPHA_RELEASE_SUMMARY.md

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update alpha release summary for v${{ needs.quality.outputs.version }}"
            
            # Pull latest changes to avoid conflicts
            git pull origin main --rebase || true
            
            # Push changes with retry
            for i in {1..3}; do
              if git push; then
                echo "Push successful on attempt $i"
                break
              else
                echo "Push failed on attempt $i, retrying..."
                sleep 5
              fi
            done
          fi
