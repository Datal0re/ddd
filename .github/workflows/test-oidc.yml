name: Test OIDC

on:
  workflow_dispatch: # Allow manual triggering for testing

permissions:
  id-token: write # Required for OIDC
  contents: read # Required for checkout

jobs:
  test-oidc:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js with clean environment
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install latest npm CLI
        run: npm install -g npm@latest

      - name: Debug environment
        run: |
          echo "=== Environment Debug Info ==="
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "OIDC token available: ${ACTIONS_ID_TOKEN_REQUEST_TOKEN:+yes}"
          echo "OIDC token length: ${#ACTIONS_ID_TOKEN_REQUEST_TOKEN}"
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Workflow: $GITHUB_WORKFLOW"
          echo "Ref: $GITHUB_REF"
          echo "Runner OS: $RUNNER_OS"

          echo "=== npm config ==="
          npm config list

      - name: Clean npm environment
        run: |
          # Reset npm config to ensure no conflicts
          npm config delete registry
          npm config delete //registry.npmjs.org/:_authToken
          npm config set registry https://registry.npmjs.org/

      - name: Install dependencies
        run: npm ci

      - name: Test package build
        run: npm pack --dry-run

      - name: Test OIDC authentication (dry run)
        run: |
          echo "=== Testing OIDC Authentication ==="
          echo "This should work with OIDC if configured correctly..."
          npm publish --dry-run --access public
